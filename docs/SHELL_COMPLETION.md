# Shell Completion

Para provides comprehensive shell completion support for bash, zsh, and fish shells, with intelligent context-aware suggestions.

## Quick Setup

### Automatic Installation (Recommended)

```bash
para init
```

This command automatically:
- Detects your shell (bash, zsh, or fish)
- Installs completion scripts to your shell configuration
- Creates backups of your existing configuration
- Provides setup instructions

### Manual Installation

If you prefer manual installation or need to troubleshoot:

```bash
# Get the completion script
PARA_COMPLETION_SCRIPT=1 para completion <shell>

# For installation instructions
PARA_COMPLETION_HELP=1 para completion <shell>
```

## Supported Shells

### Bash
- **Config file**: `~/.bashrc`
- **Installation**: `echo 'eval "$(PARA_COMPLETION_SCRIPT=1 para completion bash)"' >> ~/.bashrc`
- **Alternative**: Install to `/etc/bash_completion.d/para` or `~/.local/share/bash-completion/completions/para`

### Zsh
- **Config file**: `~/.zshrc`
- **Installation**: `echo 'eval "$(PARA_COMPLETION_SCRIPT=1 para completion zsh)"' >> ~/.zshrc`
- **Alternative**: Install to `~/.zsh_completions/_para` or `/usr/local/share/zsh/site-functions/_para`

### Fish
- **Config file**: `~/.config/fish/config.fish`
- **Installation**: `PARA_COMPLETION_SCRIPT=1 para completion fish > ~/.config/fish/completions/para.fish`
- **Alternative**: Install to `/usr/share/fish/vendor_completions.d/para.fish`

## Smart Completion Features

Para's completion system provides context-aware suggestions based on your current repository state and para sessions:

### Session Name Completion
- `para resume <TAB>` - Shows active session names
- `para cancel <TAB>` - Shows active session names
- `para recover <TAB>` - Shows archived session names
- `para finish [message] <TAB>` - Shows session names for the optional session parameter

### Branch Name Completion
- `para finish --branch <TAB>` - Shows git branch names
- `para finish --target <TAB>` - Shows git branch names
- Automatically filters out para's internal branches (e.g., `para/session-name`)

### File Path Completion
- `para start --file <TAB>` - Prioritizes task files (`TASK_*.md`, `*.md`, `*.txt`)
- `para dispatch --file <TAB>` - Smart completion for prompt files
- Regular file completion is also available

### Shell Type Completion
- `para completion <TAB>` - Shows available shells (`bash`, `zsh`, `fish`)

### Config Command Completion
- `para config <TAB>` - Shows config subcommands (`setup`, `auto`, `show`, `edit`, `reset`)

## Enhanced Dynamic Features

### Context-Aware Behavior
- **Session Detection**: Automatically queries para for active and archived sessions
- **Git Integration**: Reads git branches from the current repository
- **Error Handling**: Gracefully handles missing configuration or git repositories
- **Timeout Protection**: Prevents shell startup blocking with 2-second timeouts

### Command-Specific Logic
- **Bash**: Full completion with function definitions and command context
- **Zsh**: Rich descriptions and typed completion arguments
- **Fish**: Efficient function-based completion with smart filtering

## Implementation Details

### Completion Architecture
Para uses a hybrid approach combining:
1. **Basic Completion**: Generated by clap for command and option completions
2. **Enhanced Completion**: Custom shell functions for dynamic content
3. **Helper Commands**: Hidden commands (`_completion_sessions`, `_completion_branches`)

### Performance Optimizations
- **Recursive Call Prevention**: Uses `PARA_COMPLETION_SCRIPT` environment variable
- **Timeout Protection**: Prevents hanging on slow file operations
- **Silent Failure**: Completion errors don't interrupt shell usage
- **Efficient Queries**: Minimal git and para operations

### Security Considerations
- **Timeout Limits**: 2-second timeout for completion queries
- **Error Isolation**: Completion failures don't affect shell stability
- **Safe Defaults**: Falls back to basic completion when dynamic features fail

## Troubleshooting

### Common Issues

**Completions not working after installation:**
```bash
# Reload your shell configuration
source ~/.bashrc    # bash
source ~/.zshrc     # zsh
source ~/.config/fish/config.fish  # fish
```

**Completions are slow:**
- Check if you have `timeout` command available
- Ensure para binary is in your PATH
- Verify git repository is in good state

**Session completions not showing:**
- Ensure para is properly configured (`para config show`)
- Check if you have active sessions (`para list`)
- Verify state directory permissions

### Testing Completion
You can test completion generation manually:
```bash
# Test basic completion
para completion bash

# Test enhanced completion with dynamics
PARA_COMPLETION_SCRIPT=1 para completion bash

# Test session completion
para _completion_sessions

# Test branch completion
para _completion_branches
```

### Debugging
Enable debug output by setting environment variables:
```bash
export PARA_COMPLETION_DEBUG=1
# Then try completion to see debug information
```

## Advanced Usage

### Custom Installation Paths
Para supports installing completions to custom locations:

```bash
# System-wide installation (requires sudo)
sudo mkdir -p /usr/local/share/zsh/site-functions
PARA_COMPLETION_SCRIPT=1 para completion zsh | sudo tee /usr/local/share/zsh/site-functions/_para

# User-specific zsh completion directory
mkdir -p ~/.zsh_completions
PARA_COMPLETION_SCRIPT=1 para completion zsh > ~/.zsh_completions/_para
# Add to ~/.zshrc: fpath=(~/.zsh_completions $fpath)
```

### Integration with Other Tools
Para completion works well with:
- **Bash-completion**: Automatic integration when installed system-wide
- **Oh My Zsh**: Compatible with zsh completion system
- **Fish shell**: Native fish completion support

## Configuration

The completion system respects para's configuration:
- **Branch prefix**: Uses configured branch prefix for filtering
- **State directory**: Queries sessions from configured state directory
- **Git settings**: Respects git repository configuration

No additional configuration is needed - completions automatically adapt to your para configuration.