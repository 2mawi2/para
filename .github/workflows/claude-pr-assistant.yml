name: Claude PR Assistant

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude-code-action:
    if: |
      (
        (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude') && (github.event.comment.user.login == '2mawi2' || github.event.comment.user.login == 'app/github-actions')) ||
        (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude') && github.event.comment.user.login == '2mawi2') ||
        (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude') && github.event.review.user.login == '2mawi2') ||
        (github.event_name == 'issues' && contains(github.event.issue.body, '@claude') && github.event.issue.user.login == '2mawi2')
      )
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - name: Install dependencies
        run: |
          # Install just command runner
          curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin
          
          # Install Rust toolchain
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Run Claude PR Action
        uses: 2mawi2/claude-code-action-extended@main
        with:
          use_oauth: true
          model: "claude-sonnet-4-20250514"
          claude_access_token: ${{ secrets.CLAUDE_ACCESS_TOKEN }}
          claude_refresh_token: ${{ secrets.CLAUDE_REFRESH_TOKEN }}
          claude_expires_at: ${{ secrets.CLAUDE_EXPIRES_AT }}
          github_token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          timeout_minutes: "60"
          allowed_tools: "Edit,Read,Write,MultiEdit,Glob,Grep,LS,TodoRead,TodoWrite,Bash(just test),Bash(just test *),Bash(just test-only),Bash(just test-only *),Bash(just lint),Bash(just fmt),Bash(just fmt-check),Bash(just build),Bash(just build-release),Bash(just run),Bash(just run *),Bash(just clean),Bash(just status),Bash(cargo test),Bash(cargo test *),Bash(cargo build),Bash(cargo build --release),Bash(cargo check),Bash(cargo clippy),Bash(cargo clippy *),Bash(cargo fmt),Bash(cargo fmt --check),Bash(cargo run),Bash(cargo run *),Bash(cargo clean),Bash(rustc --version),Bash(rustfmt),Bash(clippy),Bash(git diff),Bash(git diff *),Bash(git log),Bash(git log *),Bash(git status),Bash(git status *),Bash(git show),Bash(git show *),Bash(git branch),Bash(git branch *),Bash(git rev-parse),Bash(git rev-parse *),Bash(git blame),Bash(git blame *),Bash(git fetch),Bash(git fetch *),Bash(git merge),Bash(git merge *),Bash(git add),Bash(git add *),Bash(git commit),Bash(git commit *),Bash(git push),Bash(git push *),Bash(git pull),Bash(git pull *),Bash(git rebase),Bash(git rebase *),Bash(git checkout),Bash(git checkout *),Bash(git reset),Bash(git reset *),Bash(git stash),Bash(git stash *),Bash(echo),Bash(cat),Bash(grep),Bash(rg),Bash(which),Bash(pwd),Bash(ls),Bash(head),Bash(tail),Bash(wc),Bash(jq),mcp__github_file_ops__commit_files,mcp__github_file_ops__delete_files,mcp__github_file_ops__update_claude_comment,mcp__github__create_pending_pull_request_review,mcp__github__add_pull_request_review_comment_to_pending_review,mcp__github__submit_pending_pull_request_review,mcp__github__get_pull_request_diff"
          custom_instructions: |
            You have been granted tools for editing files and running Rust/just commands for testing and validating your changes:
            
            **CRITICAL REQUIREMENTS:**
            ⚠️ The GitHub Actions pipeline will FAIL if tests or lints don't pass!
            ⚠️ You MUST ensure BOTH `just test` AND `just lint` pass with NO errors before committing!
            ⚠️ If either command fails, you have NOT completed your task successfully!
            
            **Testing & Validation Commands:**
            - `just test` - Run comprehensive tests (formatting + tests + linting) - MUST BE GREEN
            - `just test <pattern>` - Run specific tests matching a pattern
            - `just lint` - Run clippy linting - MUST SHOW NO ERRORS
            - `just fmt` - Format code automatically (run this if formatting fails)
            - `just fmt-check` - Check if code is properly formatted
            - `just build` - Build debug binary
            - `just build-release` - Build optimized release binary
            
            **Cargo Commands (if needed):**
            - `cargo test <pattern>` - Run specific Rust tests
            - `cargo clippy` - Run linting with detailed suggestions
            - `cargo fmt` - Fix formatting issues automatically
            
            **Git Commands:**
            - `git diff`, `git status` - Check your changes
            - `git log`, `git blame` - Investigate code history
            - `git fetch`, `git merge`, `git add`, `git commit`, `git push` - Version control operations
            - `git rebase`, `git checkout`, `git reset`, `git stash` - Advanced git operations
            
            **File Operations:**
            - Edit, Read, Write, MultiEdit - Make code changes
            - Glob, Grep, LS - Search and explore the codebase
            - rg (ripgrep) - Fast pattern searching
            
            **GitHub Integration:**
            - mcp__github_file_ops__commit_files - Commit your changes
            - mcp__github_file_ops__update_claude_comment - Update your comment with progress
            - mcp__github__create_pending_pull_request_review - Create PR reviews
            
            **WORKFLOW REQUIREMENTS:**
            1. Make your code changes
            2. Run `just fmt` to fix any formatting issues
            3. Run `just test` - MUST pass with "All Rust checks passed!"
               - IMPORTANT: Always use `just test` without any arguments (no filters)
               - Do NOT use `just test worktree` or `cargo test specific_test`
               - The full test suite must pass for PR approval
            4. Run `just lint` separately - MUST show NO warnings or errors
            5. Only commit if BOTH commands succeed
            6. If any test or lint fails, fix the issues and repeat steps 3-4
            
            Remember: The pipeline enforces these checks. A PR with failing tests or lints will be automatically rejected!